<div class="desktop-container">
  <!-- Desktop Background Wrapper -->

  <div class="header-bar">MemePatra - Meme Generator</div>

  <div class="main-body">
    <!-- Left Column: Edit Your Meme -->
    <div class="win-window panel left-panel" [class.minimized]="isLeftMinimized">
      <div class="win-title-bar">
        <span>Meme Generator</span>
        <div class="win-controls">
          <button class="win-btn small-btn" (click)="toggleMinimize('left')">
            {{ isLeftMinimized ? "‚ñ°" : "_" }}
          </button>
        </div>
      </div>
      <div class="window-inner-content" *ngIf="!isLeftMinimized">
        <!-- Loader -->

        <div class="input-group">
          <label>Upload Source</label>
          <app-windows-loader *ngIf="isLoading()"></app-windows-loader>
          <div *ngIf="!isLoading()" class="file-upload-wrapper win-input-inset" [class.has-file]="file()">
            <input type="file" class="file-input" placeholder="Upload file" accept=".pdf,.docx"
              (change)="onFileSelected($event)" [style.display]="file() ? 'none' : 'block'" />
            <div *ngIf="file()" class="selected-file-display">
              <span>{{ file()?.name }}</span>
              <button class="win-btn small-btn" (click)="removeFile()">
                X
              </button>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label>Context Language</label>
          <div class="context-switch">
            <button class="win-btn" [class.active]="contextLanguage() === 'Nepali'" (click)="setContext('Nepali')">
              Nepali
            </button>
            <button class="win-btn" [class.active]="contextLanguage() === 'English'" (click)="setContext('English')">
              English
            </button>
          </div>
        </div>

        <div class="input-group">
          <div class="label-row">
            <label>Instructions</label>
          </div>
          <textarea placeholder="Enter instructions..." class="instruction-area win-input"
            (input)="updateInstructions($event)"></textarea>
        </div>

        <div class="action-buttons">
          <button class="win-btn" (click)="onGenerate()">Generate meme</button>
        </div>
      </div>
    </div>

    <!-- Center Column: Preview -->
    <div class="win-window panel center-panel" [class.minimized]="isCenterMinimized">
      <div class="win-title-bar">
        <span>Meme Preview</span>
        <div class="win-controls">
          <button class="win-btn small-btn" (click)="toggleMinimize('center')">
            {{ isCenterMinimized ? "‚ñ°" : "_" }}
          </button>
        </div>
      </div>
      <div class="window-inner-content center-content" *ngIf="!isCenterMinimized">
        <!-- Loading State for Generation -->
        <app-windows-loader *ngIf="isLoading()"></app-windows-loader>

        <!-- Placeholder -->
        <div class="image-preview-placeholder win-input-inset" *ngIf="
            !isLoading() && generatedMemes().length === 0 && !selectedTemplate()
          ">
          <div style="text-align: center; padding: 20px">
            <p>No memes generated yet.</p>
            <img src="https://i.imgflip.com/30b1gx.jpg" alt="Placeholder" class="preview-img"
              style="max-width: 200px; margin-top: 10px; opacity: 0.5" />
          </div>
        </div>

        <!-- Generated Meme Display OR Selected Template -->
        <div class="generated-meme-display" *ngIf="
            !isLoading() && (generatedMemes().length > 0 || selectedTemplate())
          ">
          <!-- 1. Prev Button (Left) -->
          <button class="nav-btn left" *ngIf="!selectedTemplate()" (click)="prevMeme()" title="Previous Meme">
            &lt;
          </button>

          <!-- 2. The Meme Card (Center) -->
          <div class="meme-card">
            <!-- Download Button -->
            <button class="download-btn" (click)="downloadMeme()">üíæ</button>

            <!-- Image: Either Generated OR Manual Template -->
            <img [src]="
                selectedTemplate()
                  ? selectedTemplate()
                  : generatedMemes()[currentMemeIndex()].generated_image_url ||
                    'https://placehold.co/600x400?text=Generation+Failed'
              " class="preview-img" alt="Meme" />

            <!-- Draggable Text Wrapper -->
            <div class="draggable-text-wrapper" *ngIf="selectedTemplate()" cdkDrag cdkDragBoundary=".meme-card">
              <div class="text-handle" cdkDragHandle></div>

              <textarea *ngIf="isManualEditMode()" class="retro-text-input" [value]="manualText()"
                (input)="updateManualText($event)" (mousedown)="$event.stopPropagation()"></textarea>

              <pre *ngIf="!isManualEditMode()" class="retro-text">{{ manualText() }}</pre>
            </div>

            <!-- Caption (Only for AI Generated) -->
            <div class="meme-caption" *ngIf="!selectedTemplate()">
              {{ generatedMemes()[currentMemeIndex()].external_caption }}
            </div>

            <!-- Edit Controls (Inside Card Area) -->
            <button class="win-btn edit-toggle-btn" *ngIf="selectedTemplate()" (click)="toggleEditMode()"
              style="margin-top: 5px">
              {{ isManualEditMode() ? "Done" : "Edit Text" }}
            </button>
          </div>

          <!-- 3. Details Sidebar (Right of Image) -->
          <div class="meme-details-sidebar" *ngIf="!selectedTemplate()">
            <div class="sidebar-header">Meme Properties</div>
            <div class="sidebar-content">
              <div class="prop-row">
                <strong>Style:</strong>
                <span>{{ generatedMemes()[currentMemeIndex()].style }}</span>
              </div>
              <div class="prop-row">
                <strong>CTA:</strong>
                <span>{{ generatedMemes()[currentMemeIndex()].cta }}</span>
              </div>
              <div class="prop-row">
                <strong>Target:</strong>
                <span>{{
                  generatedMemes()[currentMemeIndex()].target_audience
                  }}</span>
              </div>
              <div class="prop-row">
                <strong>Controversy:</strong>
                <span>{{
                  generatedMemes()[currentMemeIndex()].controversy_level
                  }}</span>
              </div>
              <div class="prop-row separator"></div>
              <div class="prop-row">
                <strong>Virality:</strong>
                <div class="virality-bar">
                  <div class="fill" [style.width.%]="
                      generatedMemes()[currentMemeIndex()].virality_score
                    "></div>
                </div>
                <span>{{
                  generatedMemes()[currentMemeIndex()].virality_score
                  }}/100</span>
              </div>
            </div>
          </div>

          <!-- 4. Next Button (Right) -->
          <button class="nav-btn right" *ngIf="!selectedTemplate()" (click)="nextMeme()" title="Next Meme">
            &gt;
          </button>
        </div>

        <!-- Recent Generations History -->
        <div class="recent-generations" *ngIf="generatedMemesHistory().length > 0">
          <img *ngFor="let meme of generatedMemesHistory()"
            [src]="meme.generated_image_url || 'https://placehold.co/60x60'" class="history-thumb"
            (click)="restoreMeme(meme)" title="Restore this meme">
        </div>
      </div>
    </div>

    <!-- Right Column: Meme Templates -->
    <div class="win-window panel right-panel" [class.minimized]="isRightMinimized">
      <div class="win-title-bar">
        <span>{{
          activeTab === "trendy" ? "Trendy Memes üî•" : "Your Templates"
          }}</span>
        <div class="win-controls">
          <button class="win-btn small-btn" (click)="toggleMinimize('right')">
            {{ isRightMinimized ? "‚ñ°" : "_" }}
          </button>
        </div>
      </div>

      <div class="window-inner-content">
        <!-- Tab Toggle -->
        <div class="context-switch">
          <button class="win-btn" [class.active]="activeTab === 'trendy'" (click)="setActiveTab('trendy')">
            Trendy
          </button>
          <button class="win-btn" [class.active]="activeTab === 'custom'" (click)="setActiveTab('custom')">
            Your Templates
          </button>
        </div>

        <div class="template-actions" *ngIf="activeTab === 'custom'">
          <label class="win-btn upload-btn">
            Add Template
            <input type="file" accept="image/*" (change)="onTemplateUpload($event)" style="display: none" />
          </label>
        </div>
        <div class="meme-list-container win-input-inset">
          <!-- Trendy Grid -->
          <div class="template-grid" *ngIf="activeTab === 'trendy'">
            <div *ngFor="let tmpl of trendyTemplates" class="meme-item" (click)="selectTemplate(tmpl.url)">
              <img [src]="tmpl.url" alt="Trendy Meme" />
              <div class="stats-overlay">
                <span>‚ù§Ô∏è {{ tmpl.likes }}</span>
                <span>üîó {{ tmpl.shares }}</span>
              </div>
            </div>
          </div>

          <!-- Dynamic Grid -->
          <div class="template-grid" *ngIf="activeTab === 'custom'">
            <div *ngFor="let tmpl of templates()" class="meme-item" (click)="selectTemplate(tmpl)">
              <img [src]="tmpl" alt="Template" />
            </div>
            <div *ngIf="templates().length === 0" style="padding: 10px; text-align: center; color: gray">
              No uploads yet.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>